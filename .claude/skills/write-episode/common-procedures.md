# 共通手順リファレンス

## 目次

- [エージェント出力の検証](#エージェント出力の検証)
- [ディスカッション管理](#ディスカッション管理)

---

## エージェント出力の検証

各ステップでエージェントの完了報告（idle通知）を受けた後、以下の手順で出力を検証する:

1. Glob ツールで期待されるファイルパスを検索する
2. ファイルが存在する場合、Read ツールで内容を確認し、実質的な内容があるか（空ファイルや数行のテンプレートのみでないか）を検証する
3. 検証成功 → 次のステップへ進む
4. 検証失敗（ファイルが存在しない、または内容が不十分）の場合:
   a. リトライ回数が 2 未満なら、SendMessage で当該エージェントに再指示を送る:
      「{期待ファイル} が確認できません。ファイルを生成して報告してください。」
   b. 再度完了報告を待ち、検証を繰り返す
   c. リトライ回数が 2 に達した場合 → ユーザーにエラーを報告し、ワークフローを中断する

※ Step 5 の並列読者エージェントでは、失敗したエージェントのみリトライする（成功したエージェントは再実行しない）

---

## ディスカッション管理

各ディスカッションフェーズ（Step 2D, 4D, 6.5D）で以下のプロトコルに従う:

1. **招待**: 対象メンバーにトピックとコンテキストを SendMessage で送信。末尾に「特に意見がなければ『問題ありません』と報告してください」を付記する
2. **応答待ち**: 全対象メンバーの idle 通知を待つ
3. **即時合意判定**: 全参加者の応答テキストを確認し、以下の合意キーワードのいずれかのみで応答しているか判定する:
   - 合意キーワード: 「問題なし」「確認しました」「方針了解」「異論なし」「追加情報なし」「問題ありません」
   - **全参加者が合意キーワードで応答** → 即座にディスカッション終了（discussion-log.md に「議論なし（即時合意）」と記録）。ラウンド管理に進まず、次ステップへ
   - **1名でも実質的な意見あり** → 通常のラウンド管理（項目4）に移行
4. **ラウンド管理**: idle 通知のサイクルをラウンドとしてカウント
   - Step 2D / 4D: 最大2ラウンド
   - Step 6.5D: 最大3ラウンド
5. **打ち切り**: 最大ラウンド到達時、全メンバーに「ディスカッション終了。現在の方針/判定で進めます」を SendMessage
6. **成果物確認**: ディスカッションの結果ファイル更新が必要な場合（2D→direction更新、6.5D→consolidated-feedback作成）、担当エージェントに指示し出力を検証
7. **記録**: ディスカッション終了後、workspace/discussion-log.md に以下を追記:
   - 参加者、ラウンド数、概要（2〜3文）、成果物変更の有無
   議論が発生しなかった場合も「議論なし」と記録する
