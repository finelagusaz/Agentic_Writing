# 確定・保存・事後処理の詳細

## 目次

- [episode-summaries.md 更新ルール](#episode-summariesmd-更新ルール)
- [series-tracker.md 更新ルール](#series-trackermd-更新ルール)
- [Step 7.5: 申し送り事項更新](#step-75-申し送り事項更新)
- [Step 7.6: プロット更新ディスカッション + 品質ログ](#step-76-プロット更新ディスカッション--品質ログ)

---

## episode-summaries.md 更新ルール

`story/episode-summaries.md` を更新する:

a. 「直近エピソード詳細」セクションに今話のあらすじを追記（100〜150字）
b. 直近エピソード詳細が5話を超えた場合:
   - 最も古い話を「直近エピソード詳細」から削除する
   （アーク要約に含まれているため詳細は不要）
c. アーク境界に達した場合（`story/plot-outline.md` の幕区分を参照）:
   - 当該アークの全話を6〜8行のアーク要約に圧縮する
   - 「アーク要約」セクションの末尾（`<!-- ↑ アークが閉じるたびにここに追加される -->` コメントの直前）に追加する
   - 【主な伏線】にアーク内で張られた重要伏線を列挙する
   - 圧縮後、該当話の詳細あらすじを「直近エピソード詳細」から削除する
   - 長い幕は自然な区切りでサブアークに分割してよい

---

## series-tracker.md 更新ルール

`story/series-tracker.md` を更新する:

- **アクション配分**: テーブルをスライドし、最も古い行を削除して今話の行を追加。「次話の制約」を今話を含む直近3話の配分から再計算して更新する
- **キャラクター登場密度**: 今話の列を追加し、最も古い列（5話より前）を削除する。テーブルに存在しないキャラで、今話に登場したキャラまたは次話以降も追跡が必要なキャラがいれば行を追加する（既存列は `—` で初期化し、今話列のみ評価記号を記入）。各キャラの「薄い回連続」を再計算する。2話連続△以下のキャラがいれば「現在の警告」を更新する
- **伏線・要素の進展追跡**: 今話で進展した要素の「最終進展話」「最終進展の具体的内容」を更新し「未進展話数」を0にリセットする。進展しなかった要素の「未進展話数」を+1する。2話以上未進展の要素があれば「現在の警告」を更新する。新たに追跡すべき要素があれば行を追加する
- **表現パターン累積**: 確定したエピソード本文を Grep で走査し、今話の「身体部位比喩（抽象）」と「ダッシュ（——）」の回数をカウントして更新する。最も古い話のカウントを削除し5話合計を再計算する。さらに各行の「状態」を更新する（`1話上限` が数値なら「今話回数 > 上限」で `要分散`、それ以外は `正常`。`1話上限` が `—` の行は「5話合計 >= 10」で `要分散`、未満は `正常`）

---

## Step 7.5: 申し送り事項更新

SendMessage で **editor** に指示: 第{番号}話の確定を受けて申し送り事項を更新。以下を読み込むこと:
- `agents/editor.md`（「申し送り事項の管理」セクション）
- `episodes/{番号:2桁}_{タイトル}.txt`（確定した本文）
- `workspace/manager-review.md`
- `workspace/reader-feedback-*.md`（全読者分）
- `story/handover-notes.md`

`story/handover-notes.md` を更新し、見出しの話番号を「第{番号+1}話より」に更新すること。完了報告を待つ。

progress.md を更新: step7.5 を `[x]`、`current_step: "step7.5"`, `step_status: "completed"`

---

## Step 7.6: プロット更新ディスカッション + 品質ログ

### プロット更新

**editor** に SendMessage: 第{番号}話の確定を受けて `story/plot-outline.md` の更新要否を検討。以下を読み込み、agents/editor.md の「プロット更新の管理」ガイドラインに従う:
- `story/plot-outline.md`, `story/handover-notes.md`, `story/episode-summaries.md`

確認事項:
1. 今話で実際に描かれた展開が plot-outline.md の記述と乖離していないか
2. handover-notes.md の [DEFERRED] 項目が未来の話の展開に影響するか
3. 未来の話（特に次話〜3話先）のプロット概要に追記・修正すべき点はあるか

修正が必要な場合は manager と相談の上、plot-outline.md を更新。修正不要であれば「プロット変更なし」と報告。

**manager** に SendMessage: editor がプロットの更新を検討中。`story/plot-outline.md` を読み、設定整合性の観点から確認。editor からメッセージがあれば議論に参加。特になければ「確認しました」と報告。

**ディスカッション管理**:
- 最大2ラウンド
- editor が「プロット変更なし」と報告 → 即終了
- editor が `plot-outline.md` を更新した場合、Read で内容を確認し、`agents/editor.md` の「プロット更新の管理」ガイドラインに違反していないか検証する
  - 違反がある場合（大筋の変更、4話以上先の大幅変更）→ editor に差し戻し、該当箇所の削除を指示
- discussion-log.md に記録を追記

### 品質ログ記録

ディスカッション完了後、`story/quality-log.md` に品質記録を追記する（ファイルが存在しない場合はヘッダー付きで新規作成）。

記録する列:
- 話数、タイトル、リビジョン回数、Manager判定
- 各ペルソナ★（全ペルソナ分）、平均★、中央値★
- 議論回数（ディスカッションが発生したフェーズ数。discussion-log.md で「議論なし」以外のエントリを数える。**Step 7.6 の議論も含む**）
- ポリッシュ（Step 6.5P が発動したか: `○` / `-`）
- 主要指摘（最も頻出した指摘カテゴリを1語で: テンポ/描写/整合性/構成/表現/なし 等）
- 判定（PASS / PASS_WITH_POLISH / FORCE_PASS）

progress.md を更新: step7.6 を `[x]`、`current_step: "step7.6"`, `step_status: "completed"`
