# 確定・保存・アーク進行更新の詳細

## 目次

- [確定・保存（エピソードファイル）](#確定保存エピソードファイル)
- [episode-summaries.md 更新ルール](#episode-summariesmd-更新ルール)
- [series-tracker.md 更新ルール](#series-trackermd-更新ルール)
- [アーク進行更新](#アーク進行更新)
- [Step 7.5: 品質ログ記録](#step-75-品質ログ記録)

---

## 確定・保存（エピソードファイル）

リーダー（あなた自身）が直接実行する:

1. `workspace/episode-brief.md` からエピソードタイトルを取得する（「シーン構成・文字数目安」またはブリーフ末尾から）。タイトルが明記されていない場合は `workspace/current-draft.txt` の1行目から取得する。
2. `workspace/current-draft.txt` を `episodes/{番号:2桁}_{タイトル}.txt` へコピーする。
3. 以下の順に更新処理を実行する:
   - episode-summaries.md 更新（下記ルール参照）
   - series-tracker.md 更新（下記ルール参照）
   - アーク進行更新（下記ルール参照）

---

## episode-summaries.md 更新ルール

`story/episode-summaries.md` を更新する:

a. 「直近エピソード詳細」セクションに今話のあらすじを追記（100〜150字）
b. 直近エピソード詳細が5話を超えた場合:
   - 最も古い話を「直近エピソード詳細」から削除する
   （アーク要約に含まれているため詳細は不要）
c. アーク境界に達した場合（`story/scenario-arc.md` の三幕構成から幕の境界を取得）:
   - 当該幕の全話を6〜8行のアーク要約に圧縮する
   - 「アーク要約」セクションの末尾に追加する
   - 【主な伏線】にアーク内で張られた重要伏線を列挙する
   - 圧縮後、該当話の詳細あらすじを「直近エピソード詳細」から削除する

---

## series-tracker.md 更新ルール

`story/series-tracker.md` を更新する:

- **アクション配分**: テーブルをスライドし、最も古い行を削除して今話の行を追加。「次話の制約」を今話を含む直近3話の配分から再計算して更新する
- **キャラクター登場密度**: 今話の列を追加し、最も古い列（5話より前）を削除する。テーブルに存在しないキャラで、今話に登場したキャラまたは次話以降も追跡が必要なキャラがいれば行を追加する（既存列は `—` で初期化し、今話列のみ評価記号を記入）。各キャラの「薄い回連続」を再計算する。2話連続△以下のキャラがいれば「現在の警告」を更新する
- **伏線・要素の進展追跡**: 今話で進展した要素の「最終進展話」「最終進展の具体的内容」を更新し「未進展話数」を0にリセットする。進展しなかった要素の「未進展話数」を+1する。2話以上未進展の要素があれば「現在の警告」を更新する。新たに追跡すべき要素があれば行を追加する
- **表現パターン累積**: 確定したエピソード本文を Grep で走査し、今話の「身体部位比喩（抽象）」と「ダッシュ（——）」の回数をカウントして更新する。カウントは**地の文とセリフを分離**して記録し、形式は `地の文回数(+セリフ回数)` とする。最も古い話のカウントを削除し5話合計を再計算する。**状態の判定には地の文カウントのみ使用する**
- **アーク位置との乖離チェック**: `story/scenario-arc.md` の今話の役割タグと `workspace/arc-review.md` の最終判定を照合し、「アーク乖離」列（または備考）を更新する。arc-reviewer が FORCE_PASS だった場合は「FORCE_PASS（役割未達成で強制通過）」と記録する
- **アクセント追跡テーブル更新**: `progress.md` の `accent_note_applicable` が `true` の場合に実施する。
  - 「構成パターン履歴」テーブルに今話の行を追記する。`推奨パターン` は episode-brief の示唆から取得。`実使用パターン` は確定ドラフトから判断する（作者または arc-reviewer の言及がある場合はそれを使用する）。
  - 「感覚レンズ履歴」テーブルに今話の行を追記する。同様に示唆と実使用を記録する。
  - `progress.md` の `accent_changed` が `true`（`workspace/accent-note.md` が存在した）場合:
    - `workspace/accent-note.md` を Read し、変更理由を各テーブルの `変更メモ` 列に転記する。
    - `workspace/accent-note.md` を削除する（workspace を清潔に保つ）。
  - `accent_changed` が `false` の場合: `変更メモ` 列は空欄のまま。

---

## アーク進行更新

確定後、以下の4つをオーケストレーター（あなた自身）が直接実行する。

### (a) character-arcs.md 現在ステージ更新

`story/character-arcs.md` を Read し、今話の確定ドラフト（`episodes/{番号:2桁}_{タイトル}.txt`）と `workspace/arc-review.md` を参照して、各キャラクターの現在ステージを更新する:

- 今話でステージ遷移のトリガーが発動したキャラクターは、次ステージに進める
- 変容ステージの「状態」欄を現在の記述に更新する
- 「次トリガーまでの距離」は変わらなければ更新不要

### (b) handover-notes.md アーク進行状況更新

`story/handover-notes.md` を Read し、以下を更新する:

1. **アーク進行状況テーブル**: 各キャラクターの「現ステージ」「次トリガーまでの距離」「意図的未解決期間中か」を今話終了時点に更新する
2. **スレッドのタグ再評価**:
   - `[MUST-THIS]` で今話で処理されたスレッドは削除する
   - 今話の展開から新たに生じたスレッドがあれば追加する（タグも付与する）
   - 既存スレッドのタグが今話後の状況から変わった場合は更新する（例: `[MUST-VOL]` → `[NEXT-VOL]`）
3. 見出しの話番号を「第{番号+1}話より」に更新する

### (c) series-tracker.md アーク乖離記録

上記「series-tracker.md 更新ルール」の「アーク位置との乖離チェック」を実行する（series-tracker 更新と同じタイミングで行う）。

### (d) arc-observer スポーン（幕境界の場合のみ）

`progress.md` の `arc_phase_boundary` が `true` の場合:
- arc-observer はPhase 2 として未実装のため、現時点では以下の記録のみ行う:
  - `story/handover-notes.md` に `[DESIGN-REVIEW]` タグで「第{幕番号}幕終了。Phase 2 アーク観測を実施すること」スレッドを追加する
  - ユーザーに幕境界到達を通知する（「第{幕番号}幕が完了しました。Phase 2（`/setup-arc` 次巻 または アーク観測）の実施をご検討ください」）

---

## Step 7.5: 品質ログ記録

`story/quality-log.md` に品質記録を追記する（ファイルが存在しない場合はヘッダー付きで新規作成）。

記録する列:
- 話数、タイトル、リビジョン回数、アークレビュアー最終判定
- 各ペルソナ★（全ペルソナ分）、平均★、中央値★
- ディスカッション発生回数（discussion-log.md で「議論なし」以外のエントリを数える）
- ポリッシュ（Step 6.5P が発動したか: `○` / `-`）
- 主要指摘（arc-review.md の指摘事項を1語で: テンポ/描写/役割未達/書かないこと違反/口調/なし 等）
- 判定（PASS / PASS_WITH_POLISH / FORCE_PASS）
- 幕境界（arc_phase_boundary が true なら幕番号、false なら `-`）

`progress.md` を更新: step7.5 を `[x]`、`current_step: "step7.5"`, `step_status: "completed"`
